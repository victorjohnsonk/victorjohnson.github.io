<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TinyStories Bedtime (no-past)</title>

  <!-- ONNX Runtime Web -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script>
    // point at the CDN WASM runners
    ort.env.wasm.wasmPaths = {
      "ort-wasm.wasm":               "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort-wasm.wasm",
      "ort-wasm-simd.wasm":          "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort-wasm-simd.wasm",
      "ort-wasm-threaded.wasm":      "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort-wasm-threaded.wasm",
      "ort-wasm-simd-threaded.wasm": "https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort-wasm-simd-threaded.wasm"
    };
  </script>

  <style>
    body { font-family: sans-serif; max-width:600px; margin:2em auto; }
    textarea { width:100%; box-sizing:border-box; font-size:1em; }
    button { margin:.5em .5em 0 0; padding:.5em 1em; }
    pre { background:#f4f4f4; padding:1em; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>üõèÔ∏è TinyStories Bedtime (no-past)</h1>
  <textarea id="prompt" rows="4" placeholder="Once upon a time‚Ä¶"></textarea><br>
  <button id="generate">Generate Story</button>
  <button id="random">Random Story</button>
  <pre id="story"></pre>

  <script>
    // 1) Load the no-past ONNX model
    const sessionPromise = ort.InferenceSession.create(
      "./models/TinyStories-Instruct-1M/TinyStories-Instruct-1M.onnx",
      { executionProviders: ["wasm"] }
    );

    // 2) Some default prompts
    const DEFAULT_PROMPTS = [
      "A brave little snail goes on an adventure",
      "A friendly dragon who loves cookies",
      "A lost kitten in a magical forest",
      "A spaceship that tells bedtime stories",
      "A curious cloud exploring the sky"
    ];

    // 3) Full-history greedy loop
    async function generateStory(promptText, maxNewTokens = 64) {
      const session = await sessionPromise;
      const encoder = new TextEncoder();
      const decoder = new TextDecoder();

      // start with the prompt tokens
      let allIds = Array.from(encoder.encode(promptText));

      for (let step = 0; step < maxNewTokens; step++) {
        // build int64 tensors for the entire history
        const inputIds = new ort.Tensor(
          "int64",
          BigInt64Array.from(allIds, x => BigInt(x)),
          [1, allIds.length]
        );
        const attentionMask = new ort.Tensor(
          "int64",
          BigInt64Array.from(allIds.map(_=>1), _=>BigInt(1)),
          [1, allIds.length]
        );

        // run the model
        const { logits } = await session.run({ input_ids: inputIds, attention_mask: attentionMask });

        // logits.shape = [1, seq_len, vocab_size]; take the last position
        const vocab = logits.dims[2];
        const base = (allIds.length - 1) * vocab;
        const data = logits.data;
        // greedy argmax over the last-timestep slice
        let maxLogit = -Infinity, nextId = 0;
        for (let i = 0; i < vocab; i++) {
          const v = data[base + i];
          if (v > maxLogit) { maxLogit = v; nextId = i; }
        }

        allIds.push(nextId);

        // (optional) stop if you hit EOS token
      }

      // decode only the newly generated portion
      const newIds = allIds.slice(encoder.encode(promptText).length);
      return decoder.decode(new Uint8Array(newIds));
    }

    // wire up UI
    document.getElementById("generate").onclick = async () => {
      const p = document.getElementById("prompt").value.trim() || "Once upon a time";
      document.getElementById("story").textContent = "‚è≥ Generating‚Ä¶";
      const tale = await generateStory(p, 128);
      document.getElementById("story").textContent = p + tale;
    };
    document.getElementById("random").onclick = () => {
      const idx = Math.floor(Math.random()*DEFAULT_PROMPTS.length);
      document.getElementById("prompt").value = DEFAULT_PROMPTS[idx];
      document.getElementById("generate").click();
    };
  </script>
</body>
</html>
